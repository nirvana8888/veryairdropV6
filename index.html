<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Very Network Multisender</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        button { padding: 10px 20px; margin: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        textarea { width: 80%; height: 100px; margin: 10px 0; }
        input[type="number"] { width: 200px; padding: 5px; margin: 10px 0; }
        #status { color: green; margin-top: 10px; }
        #error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Very Network Multisender</h1>
    <p>Connect your wallet and send the same amount of $VERY to multiple addresses!</p>

    <button id="connectButton" onclick="connectWallet()">Connect Wallet</button>
    <p>Connected Address: <span id="account">Not connected</span></p>

    <h3>Enter Recipients</h3>
    <p>One address per line<br>Example:<br>0x123...abc<br>0x456...def</p>
    <textarea id="recipientsInput" placeholder="0xAddress1
0xAddress2"></textarea>

    <h3>Amount to Send to Each Address</h3>
    <input type="number" id="amountInput" step="0.01" placeholder="Enter amount in $VERY (e.g., 1.5)" />
    <br>
    <button onclick="sendVery()">Send $VERY</button>

    <p id="status"></p>
    <p id="error"></p>

    <!-- Load ethers.js from jsDelivr -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const contractAddress = "0x39abbd8be6205a4a5a7671a7424c743851c9a2e9"; // Your deployed contract address on Chain ID 4613
        const contractABI = [
            {
                "inputs": [
                    {"internalType": "address payable[]", "name": "recipients", "type": "address[]"},
                    {"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}
                ],
                "name": "multiSend",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "payable",
                "type": "function"
            },
            {"anonymous": false, "inputs": [
                {"indexed": true, "internalType": "address", "name": "to", "type": "address"},
                {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}
            ], "name": "Sent", "type": "event"}
        ];

        let provider, signer, contract;

        async function connectWallet() {
            if (window.ethereum && window.ethereum.isMetaMask) {
                try {
                    // Request wallet connection
                    await window.ethereum.request({ method: 'eth_requestAccounts' });

                    // Define Very Network (Chain ID 4613)
                    const expectedChainId = '0x120d'; // 4613 in hex
                    const veryNetwork = {
                        chainId: expectedChainId,
                        chainName: "Very Network",
                        rpcUrls: ["https://rpc.verylabs.io"],
                        nativeCurrency: {
                            name: "VERY",
                            symbol: "VERY",
                            decimals: 18
                        },
                        blockExplorerUrls: ["https://www.veryscan.io"]
                    };

                    // Get current Chain ID
                    const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                    console.log('Current Chain ID:', currentChainId, 'Decimal:', parseInt(currentChainId, 16));

                    // Switch or add network if mismatch
                    if (currentChainId !== expectedChainId) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: expectedChainId }]
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) { // Network not found
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [veryNetwork]
                                });
                            } else {
                                throw switchError;
                            }
                        }
                        // Re-check Chain ID after switch
                        const newChainId = await window.ethereum.request({ method: 'eth_chainId' });
                        console.log('New Chain ID after switch:', newChainId, 'Decimal:', parseInt(newChainId, 16));
                        if (newChainId !== expectedChainId) {
                            throw new Error(`Chain ID mismatch: expected ${expectedChainId}, got ${newChainId}`);
                        }
                    }

                    // Initialize provider
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    contract = new ethers.Contract(contractAddress, contractABI, signer);

                    const account = await signer.getAddress();
                    document.getElementById('account').innerText = account;
                    document.getElementById('status').innerText = "Wallet connected!";
                    document.getElementById('error').innerText = "";
                } catch (error) {
                    document.getElementById('error').innerText = "Connection failed: " + error.message;
                }
            } else {
                document.getElementById('error').innerText = "Please install MetaMask!";
            }
        }

        async function sendVery() {
            const recipientsInput = document.getElementById('recipientsInput').value.trim();
            const amountInput = document.getElementById('amountInput').value.trim();

            if (!recipientsInput || !amountInput || !contract) {
                document.getElementById('error').innerText = "Connect wallet, enter recipients, and specify an amount!";
                return;
            }

            try {
                const lines = recipientsInput.split('\n').filter(line => line.trim() !== '');
                const recipients = [];
                const amount = parseFloat(amountInput);

                if (amount <= 0 || isNaN(amount)) throw new Error("Amount must be a positive number");

                for (let line of lines) {
                    const address = line.trim();
                    if (!ethers.utils.isAddress(address)) throw new Error(`Invalid address: ${address}`);
                    recipients.push(address);
                }

                if (recipients.length === 0) throw new Error("No valid recipients provided");

                // Create amounts array with the same value for each recipient
                const amounts = recipients.map(() => ethers.utils.parseEther(amount.toString()));
                const totalVery = amount * recipients.length;

                document.getElementById('status').innerText = "Sending transaction...";
                document.getElementById('error').innerText = "";

                const tx = await contract.multiSend(recipients, amounts, {
                    value: ethers.utils.parseEther(totalVery.toString())
                });
                await tx.wait();

                document.getElementById('status').innerText = "Transaction successful! Check veryscan.io";
            } catch (error) {
                document.getElementById('error').innerText = "Error: " + error.message;
                document.getElementById('status').innerText = "";
            }
        }
    </script>
</body>
</html>
